var ImageCropper=function(){"use strict";function e(e){return(e.getAttribute("class")||"").split(/\s+/)}function t(e,t){if(""===t)throw new l("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new l("INVALID_CHARACTER_ERR","String contains an invalid character");return f.call(e,t)}function n(e,t){e.setAttribute("class",t.join(" "))}function i(i,o){var r=e(i);-1===t(r,o)&&(r.push(o),n(i,r))}function o(i,o){var r=e(i),s=t(r,o);-1!==s&&(r.splice(s,1),n(i,r))}function r(e,t,n,o,r){void 0===t&&(t=!1),void 0===n&&(n={}),void 0===o&&(o=null),void 0===r&&(r=!1);var s=r?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);return o&&o.appendChild(s),t&&(Array.isArray(t)?t:[t]).forEach(function(e){return i(s,e)}),Object.keys(n||{}).forEach(function(e){return s.setAttribute(e,n[e])}),s}function s(e){return"HTMLElement"in window?!!(e&&e instanceof HTMLElement):!(!e||"object"!=typeof e||1!==e.nodeType||!e.nodeName)}function a(e,t){var n=e.clientX-t.left,i=e.clientY-t.top;return{x:n<0?0:n>t.width?t.width:n,y:i<0?0:i>t.height?t.height:i}}function c(e){return Object.keys(e).reduce(function(t,n){return t.push(e[n]),t},[])}function u(e,t){return!(-1===(Array.isArray(e)?e:c(e)).indexOf(t))}function d(e,t){Object.keys(t||{}).forEach(function(n){return e[n]=t[n]})}function h(e,t){var n=~~(.5*(t.x2-t.x)),i=~~(.5*(t.y2-t.y));e.x-n<0&&(e.x=n),e.x+n>t.w&&(e.x=t.w-n),e.y-i<0&&(e.y=i),e.y+i>t.h&&(e.y=t.h-i),d(t,{x:e.x-n,x2:e.x+n,y:e.y-i,y2:e.y+i})}function p(e,t){var n=x.OFFLINE,i=Object.seal(Object.defineProperties({$$parent:null,el_content:null,el_handles:null,el_overlay:null,meta:{dimensions:{x:0,x2:0,y:0,y2:0,w:0,h:0},ratio:{w:1,h:1}},options:{update_cb:function(){},create_cb:function(){},destroy_cb:function(){},min_crop_width:100,min_crop_height:100,max_width:500,max_height:500,fixed_size:!1,mode:w.SQUARE}},{state:{get:function(){return n},set:function(e){n=e,i.$$parent&&i.$$parent.setAttribute("data-imgc-state",e)}}}));return d(i.options,t),A[e]=Object.seal(i),i}function m(){var e=A[this.$$id];if(e.state===x.LOADING){var t=e.el_content.$$source,n=t.naturalWidth,i=t.naturalHeight,o=e.options,r=o.max_width,s=o.max_height;if(n>r&&(i=~~(r*i/n),n=r),i>s&&(n=~~(s*n/i),i=s),e.meta.ratio={w:Math.floor(t.naturalWidth/n*100)/100,h:Math.floor(t.naturalHeight/i*100)/100},e.meta.dimensions.w=t.width=n,e.meta.dimensions.h=t.height=i,e.state=x.READY,e.options.fixed_size){var a=e.options,c=a.min_crop_width,u=a.min_crop_height,h=.5*(c>u?c:u);d(e.meta.dimensions,{x:.5*n-h,x2:.5*n+h,y:.5*i-h,y2:.5*i+h})}else d(e.meta.dimensions,{x2:n,y2:i});v.call(this),e.options.create_cb({w:n,h:i})}}function v(e){var t=A[this.$$id];if(t.state===x.READY){e&&e.stopPropagation();var n=t.meta,i=n.dimensions;i.x<0&&(i.x=0),i.y<0&&(i.y=0),i.x2>i.w&&(i.x2=i.w),i.y2>i.h&&(i.y2=i.h),t.el_overlay.update(i,t.options),t.el_handles.update(i,t.options),t.options.update_cb(i)}}var f=Array.prototype.indexOf||function(e){for(var t=this,n=0,i=this.length;n<i;n++)if(n in t&&t[n]===e)return n;return-1},l=function(e,t){this.name=e,this.code=DOMException[e],this.message=t};l.prototype=Error.prototype;var $="function"==typeof window.CustomEvent?window.CustomEvent:Object.defineProperties(function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n},{prototype:{value:window.Event.prototype,writable:!1,configurable:!1}}),y=function(e){var t=this;this.$$view=r("div",["imgc-content"],{},e.$$parent),this.$$source=r("img",null,{},this.$$view),this.$$source.addEventListener("load",function(){t.$$source.dispatchEvent(new $("source:fetched"))})};y.prototype.source=function(e){this.$$source.src=e};var x={OFFLINE:0,LOADING:1,READY:2},w={SQUARE:"square",CIRCULAR:"circular"},g=Object.freeze([function(e,t,n){var i=t.x;g[7](e,t,n),n.fixed_size?t.y+t.x-i<0?(t.x=i-t.y,t.y=0):t.y+=t.x-i:g[4](e,t,n)},function(e,t,n){var i=t.x2;g[5](e,t,n),n.fixed_size?t.y-t.x2+i<0?(t.x2=i+t.y,t.y=0):t.y-=t.x2-i:g[4](e,t,n)},function(e,t,n){var i=t.x2;g[5](e,t,n),n.fixed_size?t.y2+t.x2-i>t.h?(t.x2=i+(t.h-t.y2),t.y2=t.h):t.y2+=t.x2-i:g[6](e,t,n)},function(e,t,n){var i=t.x;g[7](e,t,n),n.fixed_size?t.y2+(i-t.x)>t.h?(t.x=i-(t.h-t.y2),t.y2=t.h):t.y2-=t.x-i:g[6](e,t,n)},function(e,t,n){return t.y=t.y2-e.y<n.min_crop_height?t.y2-n.min_crop_height:e.y},function(e,t,n){return t.x2=e.x-t.x<n.min_crop_width?t.x+n.min_crop_width:e.x},function(e,t,n){return t.y2=e.y-t.y<n.min_crop_height?t.y+n.min_crop_height:e.y},function(e,t,n){return t.x=t.x2-e.x<n.min_crop_width?t.x2-n.min_crop_width:e.x}]),_=function(e,t,n){function i(e){e.stopPropagation(),document.addEventListener("mouseup",o),document.addEventListener("mousemove",s)}function o(e){e.stopPropagation(),document.removeEventListener("mouseup",o),document.removeEventListener("mousemove",s)}function s(i){i.stopPropagation(),g[t](a(i,n.$$parent.getBoundingClientRect()),n.meta.dimensions,n.options),e.dispatchEvent(new $("source:dimensions"))}this.$$view=r("span",["imgc-handles-el","imgc-handles-el-"+~~(t/4)+"-"+t%4],{},e),this.$$view.addEventListener("mousedown",i)},E=function(e){function t(e){document.addEventListener("mousemove",n),document.addEventListener("mouseup",i),o(e)}function n(e){o(e)}function i(){document.removeEventListener("mouseup",i),document.removeEventListener("mousemove",n)}function o(t){h(a(t,e.$$parent.getBoundingClientRect()),e.meta.dimensions),e.$$parent.dispatchEvent(new $("source:dimensions"))}var s=this;if(!u(w,e.options.mode))throw new TypeError("Mode "+e.options.mode+" doesnt exist");this.$$view=r("div",["imgc-handles","imgc-handles-"+e.options.mode],{},e.$$parent);for(var c=0;c<(e.options.fixed_size?4:8);c++)new _(s.$$view,c,e);this.$$view.addEventListener("mousedown",t)};E.prototype.update=function(e){var t=e.x,n=e.x2,i=e.y,o=e.y2,r=e.w,s=e.h;d(this.$$view.style,{top:i+"px",left:t+"px",right:~~(r-n)+"px",bottom:~~(s-o)+"px"})};var b=function(e){this.$$view=r("svg",["imgc-overlay"],{},e.$$parent,!0),this.$$path=r("path",null,{"fill-rule":"evenodd"},this.$$view,!0)};b.prototype.update=function(e,t){var n=e.x,i=e.x2,o=e.y,r=e.y2,s=e.w,a=e.h,c=t.mode,u=.5*(i-n),d=.5*(r-o),h=i-n,p=r-o;this.$$path.setAttribute("d","M 0 0 v "+a+" h "+s+" v "+-a+" H-0zM"+(c===w.SQUARE?n+" "+o+" h "+h+" v "+p+" h "+-h+" V "+-p+" z":n+.5*h+" "+(o+.5*p)+" m "+-u+",0 a "+u+", "+d+" 0 1,0 "+h+",0 a "+u+", "+d+" 0 1,0 "+-h+" ,0 z"))};var A={},L=function(e,t,n){var o=this;if(void 0===n&&(n={}),t&&e){this.$$id=Math.random().toString(36).substring(2);var r=p(this.$$id,n),a=document.querySelector(e);if(!s(a))throw new TypeError("Does the parent exist?");r.$$parent=a,i(r.$$parent,"imgc"),this.observer=new MutationObserver(function(e){e.forEach(function(e){0===e.addedNodes.length&&e.removedNodes.length>0&&o.destroy()})}),this.observer.observe(r.$$parent.parentNode,{childList:!0,subtree:!0}),r.$$parent.addEventListener("source:fetched",m.bind(this),!0),r.$$parent.addEventListener("source:dimensions",v.bind(this),!0),r.el_content=new y(r),r.el_overlay=new b(r),r.el_handles=new E(r),this.setImage(t)}};return L.prototype.setImage=function(e){var t=A[this.$$id];t.state=x.LOADING,t.el_content.source(e)},L.prototype.destroy=function(){var e=A[this.$$id];if(this.observer.disconnect(),e.state=x.OFFLINE,s(e.$$parent)){for(;e.$$parent.firstChild;)e.$$parent.removeChild(e.$$parent.firstChild);o(e.$$parent,"imgc")}e.options.destroy_cb(),delete A[this.$$id]},L.prototype.crop=function(e,t){void 0===e&&(e="image/jpeg"),void 0===t&&(t=1);var n=A[this.$$id];e=u(["image/jpeg","image/png"],e)?"image/jpeg":e,t=t<0||t>1?1:t;var i=n.meta.dimensions,o=i.x,s=i.y,a=i.x2,c=i.y2,d=n.meta.ratio,h=d.w,p=d.h,m=a-o,v=c-s,f=r("canvas",null,{width:m,height:v});return f.getContext("2d").drawImage(n.el_content.$$source,h*o,p*s,h*m,p*v,0,0,m,v),f.toDataURL(e,t)},L}();
